<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzberichte - eContract KI</title>
    
    <!-- Unified Menu CSS -->
    <link rel="stylesheet" href="../css/unified-menu.css">
    <link rel="stylesheet" href="../css/minimal-theme.css">
    <link rel="stylesheet" href="../css/modern-responsive.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Unified Sidebar -->
    <aside id="unified-sidebar"></aside>

    <!-- Main Content -->
    <div id="main-content">
        <!-- Content Header -->
        <div class="content-header">
            <h1>üí∞ Finanzberichte</h1>
            <p class="content-header-subtitle">Finanzielle Auswertungen und Vertragswerte</p>
        </div>

        <!-- Page Content -->
        <div class="page-content">
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Gesamtumsatz</div>
                    <div class="stat-value text-success" id="totalRevenue">-</div>
                    <div class="stat-change positive" id="revenueChange">L√§dt...</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Aktive Vertr√§ge</div>
                    <div class="stat-value text-primary" id="activeValue">-</div>
                    <div class="stat-change" id="activeCount">-</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Durchschnittswert</div>
                    <div class="stat-value text-info" id="avgValue">-</div>
                    <div class="stat-change" id="avgChange">-</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">H√∂chster Vertrag</div>
                    <div class="stat-value text-warning" id="maxValue">-</div>
                    <div class="stat-change" id="maxContract">-</div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Umsatz nach Vertragstyp</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="revenueByTypeChart" style="max-height: 350px;"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Vertragswert-Verteilung</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="valueDistributionChart" style="max-height: 350px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Status-basierte Umsatzanalyse</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="statusRevenueChart" style="max-height: 350px;"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Top 10 Partner nach Umsatz</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="topPartnersChart" style="max-height: 350px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Financial Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Vertr√§ge nach Typ - Detailansicht</h3>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Vertragstyp</th>
                                <th>Anzahl</th>
                                <th>Gesamtwert</th>
                                <th>Durchschnitt</th>
                                <th>Minimum</th>
                                <th>Maximum</th>
                                <th>Anteil</th>
                            </tr>
                        </thead>
                        <tbody id="financialTable">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #9ca3af; padding: 2rem;">
                                    Lade Finanzdaten...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- Unified Menu JS -->
    <script src="../js/unified-menu.js"></script>
    
    <!-- Financial Report JS -->
    <script>
        let contracts = [];

        // Load Financial Data
        async function loadFinancialData() {
            try {
                const response = await fetch('/econtract/api/v1/contracts?all=true');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                contracts = await response.json();
                
                updateStatistics();
                createCharts();
                renderFinancialTable();
                
            } catch (error) {
                console.error('Error loading financial data:', error);
                showError(error.message);
            }
        }

        // Update Statistics
        function updateStatistics() {
            const totalRevenue = contracts.reduce((sum, c) => sum + (c.contractValue || 0), 0);
            const activeContracts = contracts.filter(c => c.status === 'ACTIVE');
            const activeValue = activeContracts.reduce((sum, c) => sum + (c.contractValue || 0), 0);
            const avgValue = contracts.length > 0 ? totalRevenue / contracts.length : 0;
            const maxContract = contracts.reduce((max, c) => 
                (c.contractValue || 0) > (max.contractValue || 0) ? c : max, contracts[0] || {});

            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('activeValue').textContent = formatCurrency(activeValue);
            document.getElementById('avgValue').textContent = formatCurrency(avgValue);
            document.getElementById('maxValue').textContent = formatCurrency(maxContract.contractValue || 0);

            document.getElementById('revenueChange').textContent = `${contracts.length} Vertr√§ge`;
            document.getElementById('activeCount').textContent = `${activeContracts.length} aktive Vertr√§ge`;
            document.getElementById('avgChange').textContent = `√ò pro Vertrag`;
            document.getElementById('maxContract').textContent = maxContract.contractNumber || '-';
        }

        // Create Charts
        function createCharts() {
            createRevenueByTypeChart();
            createValueDistributionChart();
            createStatusRevenueChart();
            createTopPartnersChart();
        }

        // Revenue by Type Chart
        function createRevenueByTypeChart() {
            const typeRevenue = {};
            contracts.forEach(c => {
                const type = c.contractType || 'Sonstige';
                typeRevenue[type] = (typeRevenue[type] || 0) + (c.contractValue || 0);
            });

            const sorted = Object.entries(typeRevenue).sort((a, b) => b[1] - a[1]).slice(0, 10);

            new Chart(document.getElementById('revenueByTypeChart'), {
                type: 'bar',
                data: {
                    labels: sorted.map(t => t[0]),
                    datasets: [{
                        label: 'Umsatz (‚Ç¨)',
                        data: sorted.map(t => t[1]),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => formatCurrency(value, true)
                            }
                        }
                    }
                }
            });
        }

        // Value Distribution Chart
        function createValueDistributionChart() {
            const ranges = {
                '< 100k': 0,
                '100k - 250k': 0,
                '250k - 500k': 0,
                '500k - 1M': 0,
                '> 1M': 0
            };

            contracts.forEach(c => {
                const value = c.contractValue || 0;
                if (value < 100000) ranges['< 100k']++;
                else if (value < 250000) ranges['100k - 250k']++;
                else if (value < 500000) ranges['250k - 500k']++;
                else if (value < 1000000) ranges['500k - 1M']++;
                else ranges['> 1M']++;
            });

            new Chart(document.getElementById('valueDistributionChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        data: Object.values(ranges),
                        backgroundColor: [
                            '#10b981',
                            '#3b82f6',
                            '#f59e0b',
                            '#ef4444',
                            '#8b5cf6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // Status Revenue Chart
        function createStatusRevenueChart() {
            const statusRevenue = {};
            contracts.forEach(c => {
                const status = c.status || 'UNKNOWN';
                statusRevenue[status] = (statusRevenue[status] || 0) + (c.contractValue || 0);
            });

            const statusLabels = {
                'ACTIVE': 'Aktiv',
                'IN_APPROVAL': 'In Genehmigung',
                'EXPIRED': 'Abgelaufen',
                'TERMINATED': 'Gek√ºndigt',
                'DRAFT': 'Entwurf',
                'IN_NEGOTIATION': 'In Verhandlung'
            };

            const data = Object.entries(statusRevenue).map(([status, value]) => ({
                status: statusLabels[status] || status,
                value
            }));

            new Chart(document.getElementById('statusRevenueChart'), {
                type: 'bar',
                data: {
                    labels: data.map(d => d.status),
                    datasets: [{
                        label: 'Umsatz (‚Ç¨)',
                        data: data.map(d => d.value),
                        backgroundColor: [
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#6b7280',
                            '#3b82f6',
                            '#8b5cf6'
                        ]
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.x)
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => formatCurrency(value, true)
                            }
                        }
                    }
                }
            });
        }

        // Top Partners Chart
        function createTopPartnersChart() {
            const partnerRevenue = {};
            contracts.forEach(c => {
                const partner = c.partnerName || 'Unbekannt';
                partnerRevenue[partner] = (partnerRevenue[partner] || 0) + (c.contractValue || 0);
            });

            const sorted = Object.entries(partnerRevenue)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            new Chart(document.getElementById('topPartnersChart'), {
                type: 'bar',
                data: {
                    labels: sorted.map(p => p[0]),
                    datasets: [{
                        label: 'Umsatz (‚Ç¨)',
                        data: sorted.map(p => p[1]),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.x)
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => formatCurrency(value, true)
                            }
                        }
                    }
                }
            });
        }

        // Render Financial Table
        function renderFinancialTable() {
            const typeStats = {};
            const totalRevenue = contracts.reduce((sum, c) => sum + (c.contractValue || 0), 0);

            contracts.forEach(c => {
                const type = c.contractType || 'Sonstige';
                if (!typeStats[type]) {
                    typeStats[type] = {
                        count: 0,
                        total: 0,
                        values: []
                    };
                }
                typeStats[type].count++;
                typeStats[type].total += (c.contractValue || 0);
                typeStats[type].values.push(c.contractValue || 0);
            });

            const tbody = document.getElementById('financialTable');
            const rows = Object.entries(typeStats)
                .sort((a, b) => b[1].total - a[1].total)
                .map(([type, stats]) => {
                    const avg = stats.total / stats.count;
                    const min = Math.min(...stats.values);
                    const max = Math.max(...stats.values);
                    const share = ((stats.total / totalRevenue) * 100).toFixed(1);

                    return `
                        <tr>
                            <td><strong>${type}</strong></td>
                            <td>${stats.count}</td>
                            <td>${formatCurrency(stats.total)}</td>
                            <td>${formatCurrency(avg)}</td>
                            <td>${formatCurrency(min)}</td>
                            <td>${formatCurrency(max)}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="flex: 1; background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;">
                                        <div style="width: ${share}%; background: #3b82f6; height: 100%;"></div>
                                    </div>
                                    <span>${share}%</span>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

            tbody.innerHTML = rows;
        }

        // Helper Functions
        function formatCurrency(value, short = false) {
            if (short && value >= 1000000) {
                return (value / 1000000).toFixed(1) + 'M ‚Ç¨';
            } else if (short && value >= 1000) {
                return (value / 1000).toFixed(0) + 'k ‚Ç¨';
            }
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function showError(message) {
            document.getElementById('financialTable').innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; color: #ef4444; padding: 2rem;">
                        ‚ö†Ô∏è Fehler beim Laden der Daten: ${message}
                    </td>
                </tr>
            `;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', loadFinancialData);
    </script>
</body>
</html>
