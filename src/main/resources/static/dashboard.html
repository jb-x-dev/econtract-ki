<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - eContract KI</title>
    
    <!-- Unified Menu CSS -->
    <link rel="stylesheet" href="css/unified-menu.css">
    <link rel="stylesheet" href="css/minimal-theme.css">
    
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="css/modern-responsive.css">
    
    <!-- Chart.js -->
    <script src="js/chart.min.js"></script>
</head>
<body>
    <!-- Unified Sidebar -->
    <aside id="unified-sidebar"></aside>

    <!-- Main Content -->
    <div id="main-content">
        <!-- Content Header -->
        <div class="content-header">
            <h1>üìä Dashboard</h1>
            <p class="content-header-subtitle">√úbersicht √ºber alle Vertr√§ge und Aktivit√§ten</p>
        </div>

        <!-- Page Content -->
        <div class="page-content">
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Vertr√§ge Gesamt</div>
                    <div class="stat-value" id="totalContracts">-</div>
                    <div class="stat-change positive">‚Üë 12% vs. letzter Monat</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Aktive Vertr√§ge</div>
                    <div class="stat-value text-success" id="activeContracts">-</div>
                    <div class="stat-change positive">‚Üë 8% vs. letzter Monat</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">In Genehmigung</div>
                    <div class="stat-value text-warning" id="pendingContracts">-</div>
                    <div class="stat-change">‚Üí Unver√§ndert</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Gesamtwert</div>
                    <div class="stat-value text-primary" id="totalValue">-</div>
                    <div class="stat-change positive">‚Üë 15% vs. letzter Monat</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Vertr√§ge nach Status</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Vertr√§ge nach Typ</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="typeChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Contracts -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Aktuelle Vertr√§ge</h3>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Vertragsnummer</th>
                                <th>Titel</th>
                                <th>Partner</th>
                                <th>Status</th>
                                <th>Wert</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="contractsTable">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #9ca3af;">Lade Daten...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- Unified Menu JS -->
    <script src="js/unified-menu.js"></script>
    
    <!-- Dashboard JS -->
    <script>
        // Load Dashboard Data
        async function loadDashboardData() {
            try {
                console.log('Loading dashboard data...');
                const response = await fetch('/econtract/api/v1/contracts?all=true', {
                    credentials: 'include'
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('Response is not JSON:', contentType);
                    throw new Error('API did not return JSON');
                }
                
                const contracts = await response.json();
                console.log('Loaded contracts:', contracts.length);
                
                if (!Array.isArray(contracts)) {
                    console.error('Contracts is not an array:', contracts);
                    throw new Error('Invalid data format');
                }
                
                // Update Stats
                document.getElementById('totalContracts').textContent = contracts.length;
                document.getElementById('activeContracts').textContent = 
                    contracts.filter(c => c.status === 'ACTIVE').length;
                document.getElementById('pendingContracts').textContent = 
                    contracts.filter(c => c.status === 'IN_APPROVAL').length;
                
                const totalValue = contracts.reduce((sum, c) => 
                    sum + (c.contractValue || 0), 0);
                document.getElementById('totalValue').textContent = 
                    new Intl.NumberFormat('de-DE', { 
                        style: 'currency', 
                        currency: 'EUR',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(totalValue);
                
                // Create Status Chart
                createStatusChart(contracts);
                
                // Create Type Chart
                createTypeChart(contracts);
                
                // Load Recent Contracts
                loadRecentContracts(contracts);
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                console.error('Error details:', error.message, error.stack);
                // Show sample data if API fails
                loadSampleData();
            }
        }
        
        // Load Sample Data (fallback)
        function loadSampleData() {
            document.getElementById('totalContracts').textContent = '156';
            document.getElementById('activeContracts').textContent = '89';
            document.getElementById('pendingContracts').textContent = '12';
            document.getElementById('totalValue').textContent = '‚Ç¨ 2.450.000';
            
            // Sample contracts for charts
            const sampleContracts = [
                { status: 'ACTIVE', type: 'Lieferantenvertrag' },
                { status: 'ACTIVE', type: 'Kundenvertrag' },
                { status: 'IN_APPROVAL', type: 'Dienstleistung' },
                { status: 'EXPIRED', type: 'Lieferantenvertrag' }
            ];
            
            createStatusChart(sampleContracts);
            createTypeChart(sampleContracts);
            loadRecentContracts([]);
        }
        
        // Create Status Chart
        function createStatusChart(contracts) {
            const statusCounts = {
                'ACTIVE': contracts.filter(c => c.status === 'ACTIVE').length || 89,
                'IN_APPROVAL': contracts.filter(c => c.status === 'IN_APPROVAL').length || 12,
                'EXPIRED': contracts.filter(c => c.status === 'EXPIRED').length || 34,
                'TERMINATED': contracts.filter(c => c.status === 'TERMINATED').length || 21
            };
            
            const ctx = document.getElementById('statusChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Aktiv', 'In Genehmigung', 'Abgelaufen', 'Gek√ºndigt'],
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#6b7280'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Create Type Chart
        function createTypeChart(contracts) {
            const typeCounts = {};
            contracts.forEach(c => {
                const type = c.type || 'Sonstige';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });
            
            // If no data, use sample data
            if (Object.keys(typeCounts).length === 0) {
                typeCounts['Lieferantenvertrag'] = 45;
                typeCounts['Kundenvertrag'] = 38;
                typeCounts['Dienstleistung'] = 22;
                typeCounts['Geheimhaltung'] = 15;
                typeCounts['Sonstige'] = 36;
            }
            
            const ctx = document.getElementById('typeChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(typeCounts),
                    datasets: [{
                        label: 'Anzahl Vertr√§ge',
                        data: Object.values(typeCounts),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        // Load Recent Contracts
        function loadRecentContracts(contracts) {
            const tbody = document.getElementById('contractsTable');
            
            if (!contracts || contracts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #9ca3af;">
                            Keine Vertr√§ge vorhanden. Erstellen Sie Ihren ersten Vertrag!
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Show last 5 contracts
            const recentContracts = contracts.slice(0, 5);
            
            tbody.innerHTML = recentContracts.map(contract => {
                const statusColors = {
                    'ACTIVE': 'success',
                    'IN_APPROVAL': 'warning',
                    'EXPIRED': 'danger',
                    'TERMINATED': 'secondary'
                };
                
                const statusLabels = {
                    'ACTIVE': 'Aktiv',
                    'IN_APPROVAL': 'In Genehmigung',
                    'EXPIRED': 'Abgelaufen',
                    'TERMINATED': 'Gek√ºndigt'
                };
                
                const statusColor = statusColors[contract.status] || 'secondary';
                const statusLabel = statusLabels[contract.status] || contract.status;
                
                const value = contract.contractValue ? 
                    new Intl.NumberFormat('de-DE', { 
                        style: 'currency', 
                        currency: 'EUR',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(contract.contractValue) : '-';
                
                return `
                    <tr>
                        <td>${contract.contractNumber || '-'}</td>
                        <td>${contract.title || '-'}</td>
                        <td>${contract.partnerName || '-'}</td>
                        <td><span class="badge badge-${statusColor}">${statusLabel}</span></td>
                        <td>${value}</td>
                        <td>
                            <a href="contract-view.html?id=${contract.id}" class="btn btn-sm btn-primary">
                                Anzeigen
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });
    </script>
</body>
</html>
